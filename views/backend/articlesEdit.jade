extends ./layout/layout
block content
  include ./layout/breadcrumbNav
  section.content(ng-controller='ArticlesEditCtrl')
    div.col-md-12
      div.box.box-solid.big-form.clearfix
        form#add
          dl.clearfix.col-md-12
            dt 标题:
            dd.form-group
              input.form-control(type='text',placeholder='请输入标题',reg='s',err-tip='标题 - 不可输入特殊字符或为空',ng-model='articleData.title')
          dl.clearfix.col-md-12
            dt 标签:
            dd.tag-group.form-group
              ul
                li.btn.btn-primary.btn-sm(ng-repeat='item in tag track by $index')
                  | {{item}}
                  span(ng-click='delTag($index)') x
              input#tag.form-control(type='text',placeholder='请输入标签,回车添加标签')
          dl.clearfix.col-md-12
            dt 正文:
            dd.form-group
              iframe.form-control(ng-src='{{frameUrl}}')
          dl.clearfix.col-md-6
            dt 置顶:
            dd.form-group.checkbox
              label
                input(type='checkbox',ng-model='articleData.state.top',ng-checked='articleData.state.top')
                | 置顶
              label
                input(type='checkbox',ng-model='articleData.state.display',ng-checked='articleData.state.display')
                | 显示
          dl.clearfix.col-md-6
            dt 操作:
            dd
              button.btn.btn-primary.pull-right(type='button',ng-click='submit()') 确 定
              div#tip.pull-right

  script.
    angular.module('Kaola', ['Kaola.tools'])
    .controller('ArticlesEditCtrl', ['$scope','db', function ($scope,db) {
      
      var onlyTag = function(key){
        var status = true;
        for(var i= 0,len=$scope.tag.length;i<len;i++){
          if($scope.tag[i] == key){
            status = false;
          }
        }
        return status;
      }
      $('#tag').keyup(function(e){
        if(e.keyCode === 13){
          var val = $(this).val();
          if(onlyTag(val) && val.replace(/\s/g,'') != ''){
            $scope.$apply(function(){
              $scope.tag.push(val)
            })
            $(this).val('').css({paddingLeft:$(this).siblings('ul').width()})
          }else{
            alert('标签已存在或不可为空')
          }
        }
      })
      $scope.delTag = function(index){
        var arr = [];
        for(var i= 0,len=$scope.tag.length;i<len;i++){
          if(i != index){
            arr.push($scope.tag[i])
          }
        }
        $scope.tag = arr;
        setTimeout(function(){$('#tag').css({paddingLeft:$('#tag').siblings('ul').width()})},100)
      }
      $scope.articleData = !{articleData};
      db.set($scope.articleData._id,$scope.articleData.content);
      $scope.tag = $scope.articleData.tag.split(',');
      setTimeout(function(){$('#tag').css({paddingLeft:$('#tag').siblings('ul').width()})},100);
      $scope.frameUrl = '/editor/index.html?md='+$scope.articleData._id;

      $scope.changeType = function(type){
        $scope.articleData.info.callType = parseInt(type);
      }
      $scope.submit = function() {
        $('#add input').each(function () {
          $(this).trigger('focus').trigger('blur');
        })
        if ($('#add .reg-success').size() === 1) {
          if(db.get($scope.articleData._id).replace(/\s/g,'').length >= 20){
            $scope.articleData.content = db.get($scope.articleData._id);
            $scope.articleData.tag = $scope.tag.join(',');
            $.post('/#{pageInfo.adminDomain}/articlesManage/editArticle',$scope.articleData,function(data){
              var status = data.status.split('::')[0],
              msg = data.status.split('::')[1];
              if(status === 'SUCCESS'){
                $('#tip').append('<div class=\'callout callout-success\'><p>'+msg+'</p></div>');
                setTimeout(function(){
                  window.location.href = './'
                },2000)
              }else{
                $('#tip').append('<div class=\'callout callout-danger\'><p>'+msg+'</p></div>');
                setTimeout(function(){
                  $('#tip').html('');
                },2000)
              }
            })
          }else{
            $('#tip').append('<div class=\'callout callout-danger\'><p>内容不可少于20字</p></div>');
            setTimeout(function(){
              $('#tip').html('');
            },2000)
          }
        }else{
          $('#tip').append('<div class=\'callout callout-danger\'><p>填写信息不完整</p></div>');
          setTimeout(function(){
            $('#tip').html('');
          },2000)
        }
      }
    }])
                                                                               
