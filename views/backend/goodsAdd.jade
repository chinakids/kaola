extends ./layout/layout
block content
  include ./layout/breadcrumbNav
  section.content(ng-controller='GoodsAddCtrl')
    div.col-md-12
      div.box.box-default.big-form.clearfix
        form#add
          dl.clearfix.col-md-12
            dt 标题:
            dd.form-group
              input.form-control(type='text',placeholder='请输入标题',reg='s',err-tip='标题 - 不可输入特殊字符或为空',ng-model='goodData.title')
          dl.clearfix.col-md-12
            dt 标签:
            dd.tag-group.form-group
              ul
                li.btn.btn-primary.btn-sm(ng-repeat='item in tag track by $index')
                  | {{item}}
                  span(ng-click='delTag($index)') x
              input#tag.form-control(type='text',placeholder='请输入标签,回车添加标签')
          dl.clearfix.col-md-4
            dt 价格:
            dd.form-group
              input.form-control(type='text',placeholder='请输入价格',reg='n',err-tip='价格 - 只可输入数字',ng-model='goodData.price')
          dl.clearfix.col-md-4
            dt 位置:
            dd.form-group
              input.form-control(type='text',placeholder='位置',reg='s',err-tip='位置 - 不可输入特殊字符或为空',ng-model='goodData.info.location')
          dl.clearfix.col-md-4
            dt 联系方式:
            dd.form-group
              div.input-group
                div.input-group-btn
                  button.btn.btn-default.dropdown-toggle(type='button',data-toggle='dropdown',aria-haspopup='true',aria-expanded='false')
                    | {{goodData.info.callType | calltype }}&nbsp;
                    span.caret
                  ul.dropdown-menu
                    li
                      a(href='javascript:;',ng-click='changeType(0)') 微信
                    li
                      a(href='javascript:;',ng-click='changeType(1)') QQ
                    li
                      a(href='javascript:;',ng-click='changeType(2)') 电话
                input.form-control(type='text',placeholder='请输入联系方式',reg='s',err-tip='联系方式 - 不可输入特殊字符或为空',ng-model='goodData.info.callWay')
          dl.clearfix.col-md-12
            dt 主图:
            dd.form-group
              div#uploader.wu-example
                div.uploader-list
                  div#thelist
                  div.btns
                    div#picker 
                      i.ion-ios-plus-empty
                      p 选择图片
          dl.clearfix.col-md-12
            dt 正文:
            dd.form-group
              iframe.form-control(src='/editor/index.html')
          dl.clearfix.col-md-6
            dt 置顶:
            dd.form-group.checkbox
              label
                input(type='checkbox',ng-model='goodData.state.top',ng-checked='goodData.state.top')
                | 置顶
              label
                input(type='checkbox',ng-model='goodData.state.display',ng-checked='goodData.state.display')
                | 显示
              label
                input(type='checkbox',ng-model='goodData.state.sell',ng-checked='goodData.state.sell')
                | 售出
          dl.clearfix.col-md-6
            dt 操作:
            dd
              button.btn.btn-primary.pull-right(type='button',ng-click='submit()')
                i.fa.fa-paper-plane-o
                |  发布
              div#tip.pull-right

  script.
    angular.module('Kaola', ['Kaola.tools'])
    .controller('GoodsAddCtrl', ['$scope','db', function ($scope,db) {
      $scope.tag = [];
      var onlyTag = function(key){
        var status = true;
        for(var i= 0,len=$scope.tag.length;i<len;i++){
          if($scope.tag[i] == key){
            status = false;
          }
        }
        return status;
      }
      $('#tag').keyup(function(e){
        if(e.keyCode === 13){
          var val = $(this).val();
          if(onlyTag(val) && val.replace(/\s/g,'') != ''){
            $scope.$apply(function(){
              $scope.tag.push(val)
            })
            $(this).val('').css({paddingLeft:$(this).siblings('ul').width()})
          }else{
            alert('标签已存在或不可为空')
          }
        }
      })
      $scope.delTag = function(index){
        var arr = [];
        for(var i= 0,len=$scope.tag.length;i<len;i++){
          if(i != index){
            arr.push($scope.tag[i])
          }
        }
        $scope.tag = arr;
        setTimeout(function(){$('#tag').css({paddingLeft:$('#tag').siblings('ul').width()})},100)
      }
      $scope.goodData = {
        title:'',
        tag:'',
        price:'',
        content:'',
        info:{
          location : '',//位置
          callType : 0,//联系方式
          callWay  : ''//联系数据
        },
        imgList:'',
        state      : {
          display  : true,//是否显示
          top      : false,//是否置顶
          sell     : false//售出状态
        }
      }
      $scope.changeType = function(type){
        $scope.goodData.info.callType = parseInt(type);
      }
      $scope.submit = function() {
        $('#add input').each(function () {
          $(this).trigger('focus').trigger('blur');
        })
        if ($('#add .reg-success').size() === 4) {
          if(db.get('newAdd').replace(/\s/g,'').length >= 20){
            $scope.goodData.content = db.get('newAdd');
            $scope.goodData.tag = $scope.tag.join(',');
            $.post('/#{pageInfo.adminDomain}/goodsManage/addGood',$scope.goodData,function(data){
              var status = data.status.split('::')[0],
              msg = data.status.split('::')[1];
              if(status === 'SUCCESS'){
                $('#tip').append('<div class=\'callout callout-success\'><p>'+msg+'</p></div>');
                setTimeout(function(){
                  window.location.href = './'
                },2000)
              }else{
                $('#tip').append('<div class=\'callout callout-danger\'><p>'+msg+'</p></div>');
                setTimeout(function(){
                  $('#tip').html('');
                },2000)
              }
            })
          }else{
            $('#tip').append('<div class=\'callout callout-danger\'><p>内容不可少于20字</p></div>');
            setTimeout(function(){
              $('#tip').html('');
            },2000)
          }
        }else{
          $('#tip').append('<div class=\'callout callout-danger\'><p>填写信息不完整</p></div>');
          setTimeout(function(){
            $('#tip').html('');
          },2000)
        }
      }
      //图片部分处理
      var uploader = WebUploader.create({
        // 选完文件后，是否自动上传。
        auto: false,
        // swf文件路径
        swf: '/lib/fex-webuploader/dist/Uploader.swf',
        // 文件接收服务端。
        server: 'http://webuploader.duapp.com/server/fileupload.php',
        // 选择文件的按钮。可选。
        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
        pick: '#picker',
        // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
        resize: false
      });
      // 当有文件添加进来的时候
      uploader.on( 'fileQueued', function( file ) {
        var $li = $(
        '<li id="' + file.id + '" class="file-item thumbnail">' +
            '<img>' +
            '<div class="info">' + file.name + '</div>' +
        '</li>'
        ),
        $img = $li.find('img');
        // $list为容器jQuery实例
        $('#thelist').append( $li );
        // 创建缩略图
        // 如果为非图片文件，可以不用调用此方法。
        // thumbnailWidth x thumbnailHeight 为 100 x 100
        uploader.makeThumb( file, function( error, src ) {
          if ( error ) {
            $img.replaceWith('<span>不能预览</span>');
            return;
          }
          $img.attr( 'src', src );
        }, 100, 100 );
      });
      // 文件上传过程中创建进度条实时显示。
      uploader.on( 'uploadProgress', function( file, percentage ) {
        var $li = $( '#'+file.id ),
        $percent = $li.find('.progress .progress-bar');
        // 避免重复创建
        if ( !$percent.length ) {
          $percent = $('<div class="progress progress-striped active">' +
            '<div class="progress-bar" role="progressbar" style="width: 0%">' +
            '</div>' +
          '</div>').appendTo( $li ).find('.progress-bar');
        }
        $li.find('p.state').text('上传中');
        $percent.css( 'width', percentage * 100 + '%' );
      });
      uploader.on( 'uploadSuccess', function( file ) {
        $( '#'+file.id ).find('p.state').text('已上传');
      });
      uploader.on( 'uploadError', function( file ) {
        $( '#'+file.id ).find('p.state').text('上传出错');
      });
      uploader.on( 'uploadComplete', function( file ) {
        $( '#'+file.id ).find('.progress').fadeOut();
      });

    }])
                                                                               
